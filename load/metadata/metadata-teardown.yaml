# Tests of metadata service.
# Notes on json validation:
#   must supply count or expected
#   if supply expected can optionally specify operator
#   operator defaults to "eq", available values are: abs contains eq ge gt index inv invert le lt ne neg not pos truth
#   operator is applied as: <actual> <operator> <expected>
---
- config:
    - testset: "Metadata: Teardown"
    - certificate_path: "/opt/loadtests/repositories/lb-load-client.pem"

- test: # verify entity exists
    - name: "Verify Entity: /metadata/entity/version"
    - metrics: {namelookup_time, connect_time, appconnect_time, pretransfer_time, starttransfer_time, redirect_time, total_time, size_download, size_upload, request_size, speed_download, speed_upload, redirect_count, num_connects }
    - warmup_runs: 0
    - benchmark_runs: 1
    - output_file: 'Verify_Entity:_/metadata/entity/version-{thread}.csv'
    - url: "/${ENTITY_NAME}/${ENTITY_VERSION}"
    - method: GET
    - headers: {Content-Type: application/json}
    - group: "metadata/GET"
    - stop_on_failure: True
    - validators:
        - {query: "objectType", operator: "empty", expected: ""}

- test:
    - name: "Delete Entity (fail)"
    - metrics: {namelookup_time, connect_time, appconnect_time, pretransfer_time, starttransfer_time, redirect_time, total_time, size_download, size_upload, request_size, speed_download, speed_upload, redirect_count, num_connects }
    - warmup_runs: 0
    - benchmark_runs: 1
    - output_file: 'Delete_Entity_(fail)-{thread}.csv'
    - url: "/${ENTITY_NAME}"
    - method: DELETE
    - headers: {Content-Type: application/json}
    - group: "metadata/DELETE"
    - validators:
        - {query: "objectType", operator: "eq", expected: "error"}
        - {query: "context", operator: "eq", expected: "RemoveEntityCommand"}
        - {query: "errorCode", operator: "eq", expected: "mongo-metadata:CannotDeleteEntity"}

- test:
    - name: "Disable ${ENTITY_VERSION_1}"
    - metrics: {namelookup_time, connect_time, appconnect_time, pretransfer_time, starttransfer_time, redirect_time, total_time, size_download, size_upload, request_size, speed_download, speed_upload, redirect_count, num_connects }
    - warmup_runs: 0
    - benchmark_runs: 1
    - output_file: 'Disable_${ENTITY_VERSION_1}-{thread}.csv'
    - url: "/${ENTITY_NAME}/${ENTITY_VERSION_1}/disabled?comment=teardown"
    - method: PUT
    - headers: {Content-Type: application/json}
    - group: "metadata/DELETE"
    - validators:
        - {query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_1}"}
        - {query: "schema/status/value", operator: "eq", expected: "disabled"}

- test:
    - name: "Clear default version"
    - metrics: {namelookup_time, connect_time, appconnect_time, pretransfer_time, starttransfer_time, redirect_time, total_time, size_download, size_upload, request_size, speed_download, speed_upload, redirect_count, num_connects }
    - warmup_runs: 0
    - benchmark_runs: 1
    - output_file: 'Clear_default_version-{thread}.csv'
    - url: "/${ENTITY_NAME}/default"
    - method: DELETE
    - group: "metadata/DELETE"
    - validators:
        - {query: "name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {query: "defaultVersion", operator: "empty", expected: ""}

- test:
    - name: "Disable ${ENTITY_VERSION_2}"
    - metrics: {namelookup_time, connect_time, appconnect_time, pretransfer_time, starttransfer_time, redirect_time, total_time, size_download, size_upload, request_size, speed_download, speed_upload, redirect_count, num_connects }
    - warmup_runs: 0
    - benchmark_runs: 1
    - output_file: 'Disable_${ENTITY_VERSION_2}-{thread}.csv'
    - url: "/${ENTITY_NAME}/${ENTITY_VERSION_2}/disabled?comment=teardown"
    - method: PUT
    - headers: {Content-Type: application/json}
    - group: "metadata/DELETE"
    - validators:
        - {query: "entityInfo/name", operator: "eq", expected: "${ENTITY_NAME}"}
        - {query: "schema/version/value", operator: "eq", expected: "${ENTITY_VERSION_2}"}
        - {query: "schema/status/value", operator: "eq", expected: "disabled"}

- test:
    - name: "Delete Entity (succeed)"
    - metrics: {namelookup_time, connect_time, appconnect_time, pretransfer_time, starttransfer_time, redirect_time, total_time, size_download, size_upload, request_size, speed_download, speed_upload, redirect_count, num_connects }
    - warmup_runs: 0
    - benchmark_runs: 1
    - output_file: 'Delete_Entity_(succeed)-{thread}.csv'
    - url: "/${ENTITY_NAME}"
    - method: DELETE
    - headers: {Content-Type: application/json}
    - group: "metadata/DELETE"

- test: 
    - name: "Verify deletion"
    - metrics: {namelookup_time, connect_time, appconnect_time, pretransfer_time, starttransfer_time, redirect_time, total_time, size_download, size_upload, request_size, speed_download, speed_upload, redirect_count, num_connects }
    - warmup_runs: 0
    - benchmark_runs: 1
    - output_file: 'Verify_deletion-{thread}.csv'
    - url: "/${ENTITY_NAME}"
    - method: GET
    - headers: {Content-Type: application/json}
    - group: "metadata/GET"
    - validators:
        - {query: "entities", operator: "count", expected: 0}
